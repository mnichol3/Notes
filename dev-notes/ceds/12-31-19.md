**Dev Notes - 31 Dec 2019**

# Emissions Freeze



## Issue 1
The following error is raised when running `CEDS_version_comparison.R` with the CMIP6 (`final-emissions/current-versions`) and CMIP6 Frozen 1970 emission factor (`final-emissions/previous-versions`) emission files:
```
Tue Dec 31 09:53:10 2019 CEDS_version_comparison.R [ 1 ] : All sectors in the in the Master_Sector_Level_map.csv are in the RCP sector mapping file...
Tue Dec 31 09:53:11 2019 CEDS_version_comparison.R [ 1 ] : Reading ../final-emissions/current-versions/CEDS_BC_emissions_by_country_CEDS_sector_v_2016_07_26.csv 
    Done:  11491  rows,  269  cols
Tue Dec 31 09:53:12 2019 CEDS_version_comparison.R [ 1 ] : Reading ../final-emissions/current-versions/CEDS_BC_global_emissions_by_fuel_v_2016_07_26.csv 
    Done:  9  rows,  268  cols
Tue Dec 31 09:53:12 2019 CEDS_version_comparison.R [ 1 ] : Reading ../final-emissions/previous-versions/CEDS_BC_emissions_by_country_CEDS_sector_v_frozen.csv 
    Done:  11491  rows,  269  cols
Tue Dec 31 09:53:14 2019 CEDS_version_comparison.R [ 1 ] : Reading ../final-emissions/previous-versions/CEDS_BC_global_emissions_by_fuel_v_frozen.csv 
    Done:  9  rows,  268  cols
Tue Dec 31 09:53:14 2019 CEDS_version_comparison.R [ 1 ] : Reading ../final-emissions/current-versions/CEDS_CH4_emissions_by_country_CEDS_sector_v_2016_07_26.csv 
    Done:  11491  rows,  269  cols
Tue Dec 31 09:53:16 2019 CEDS_version_comparison.R [ 1 ] : Reading ../final-emissions/current-versions/CEDS_CH4_global_emissions_by_fuel_v_2016_07_26.csv 
    Done:  9  rows,  268  cols
Tue Dec 31 09:53:16 2019 CEDS_version_comparison.R [ 1 ] : Reading ../final-emissions/previous-versions/CEDS_CH4_emissions_by_country_CEDS_sector_v_frozen.csv 
    Done:  11931  rows,  269  cols
Tue Dec 31 09:53:17 2019 CEDS_version_comparison.R [ 1 ] : Reading ../final-emissions/previous-versions/CEDS_CH4_global_emissions_by_fuel_v_frozen.csv 
    Done:  9  rows,  268  cols
Error in eval(ei, envir) : 
  previous_CEDS_sectors_mapped_with_ship_and_aviation should not have any NAs for RCP_sector after mapping. (503)
```

### Steps to solve
* Check files in question for missing values/`NAN`/`NA`
  * **Previous versions** (Frozen emissions)
    * `CEDS_CH4_global_emissions_by_fuel_v_frozen.csv`
      * Missing/Null values: `None`
    * `CEDS_CH4_emissions_by_country_CEDS_sector_v_frozen.csv`
      * Missing/Null values: `None` 
  * **Current versions** (CMIP6 release)
    * `CEDS_CH4_emissions_by_country_CEDS_sector_v_2016_07_26.csv`
      * Missing/Null values: `None` 
    * `CEDS_CH4_global_emissions_by_fuel_v_2016_07_26.csv`
      * Missing/Null values: `None`
  * Method
    * Read each file into Pandas DataFrame, search for missing values:
      ```
      > import pandas as pd
      > fname = 'CEDS_CH4_global_emissions_by_fuel_v_frozen.csv'
      > df = pd.read_csv(fname, sep=',', header=0)
      > df.isnull().values.any()
      False
      > df.isnull().sum()
      fuel     0
      em       0
      units    0
      X1750    0
      X1751    0
              ..
      X2010    0
      X2011    0
      X2012    0
      X2013    0
      X2014    0
      Length: 268, dtype: int64
      > fname = 'CEDS_CH4_emissions_by_country_CEDS_sector_v_frozen.csv'
      > df = pd.read_csv(fname, sep=',', header=0)
      > df.isnull().values.any()
      False
      > df.isnull().sum()
      fuel     0
      em       0
      units    0
      X1750    0
      X1751    0
              ..
      X2010    0
      X2011    0
      X2012    0
      X2013    0
      X2014    0
      Length: 268, dtype: int64
      > fname = '../current-versions/CEDS_CH4_emissions_by_country_CEDS_sector_v_2016_07_26.csv'
      > df = pd.read_csv(fname, sep=',', header=0)
      > df.isnull().values.any()
      False
      > df.isnull().sum()
      fuel     0
      em       0
      units    0
      X1750    0
      X1751    0
              ..
      X2010    0
      X2011    0
      X2012    0
      X2013    0
      X2014    0
      Length: 268, dtype: int64
      > fname = '../current-versions/CEDS_CH4_global_emissions_by_fuel_v_2016_07_26.csv'
      > df = pd.read_csv(fname, sep=',', header=0)
      > df.isnull().values.any()
      False
      > df.isnull().sum()
      fuel     0
      em       0
      units    0
      X1750    0
      X1751    0
              ..
      X2010    0
      X2011    0
      X2012    0
      X2013    0
      X2014    0
      Length: 268, dtype: int64
      ```
* Since methane (`CH4`; the species in question) was deemed non-crucial, a work-around involving using the `current-versions` methane files as `previous-versions` files was implemented
  * All frozen `CH4` files from `code/CEDS/final-emissions/previous-versions` were copied to `data/e-freeze/frozen-emissions/final-emissions`
  * All `CH4` files from `code/CEDS/final-emissions/current-versions` were copied to `data/e-freeze/CMIP6-emissions/final-emissions` (~ 12:30 p)
  * CMIP6 `CH4` files (`CEDS_CH4_*_v_2016_07_26.csv`) were copied from `CEDS/final-emissions/current-versions` to `CEDS/final-emissions/previous-versions` (~ 12:30 p)
  * The copied CH4 files were re-named using `rename_files.py`, changing the version portion of the filename from `v_2016_07_26` to `v_frozen` (~ 12:30 p)
    ```
    $ python rename_files.py -d ".../CEDS/final-emissions/previous-versions" -t "2016_07_26" -n "frozen"
    
    Changing working directory to .../CEDS/final-emissions/previous-versions...

    Renaming files...
    CEDS_CH4_emissions_by_country_CEDS_sector_v_2016_07_26.csv -->     CEDS_CH4_emissions_by_country_CEDS_sector_v_frozen.csv
    CEDS_CH4_emissions_by_country_sector_v_2016_07_26.csv -------> CEDS_CH4_emissions_by_country_sector_v_frozen.csv
    CEDS_CH4_emissions_by_country_v_2016_07_26.csv --------------> CEDS_CH4_emissions_by_country_v_frozen.csv
    CEDS_CH4_global_emissions_by_CEDS_sector_v_2016_07_26.csv ---> CEDS_CH4_global_emissions_by_CEDS_sector_v_frozen.csv
    CEDS_CH4_global_emissions_by_fuel_v_2016_07_26.csv ----------> CEDS_CH4_global_emissions_by_fuel_v_frozen.csv

    Finished!
    ```
  * `CEDS_version_comparison.R` was re-run (1:05 p)
  
### Outcome
Same warning, but for `CO2`:

```
Tue Dec 31 13:05:17 2019 CEDS_version_comparison.R [ 2 ] : Reading ../final-emissions/current-versions/CEDS_CO2_emissions_by_country_CEDS_sector_v_2016_07_26.csv 
    Done:  11491  rows,  269  cols
Tue Dec 31 13:05:18 2019 CEDS_version_comparison.R [ 2 ] : Reading ../final-emissions/current-versions/CEDS_CO2_global_emissions_by_fuel_v_2016_07_26.csv 
    Done:  9  rows,  268  cols
Tue Dec 31 13:05:18 2019 CEDS_version_comparison.R [ 2 ] : Reading ../final-emissions/previous-versions/CEDS_CO2_emissions_by_country_CEDS_sector_v_frozen.csv 
    Done:  11931  rows,  269  cols
Tue Dec 31 13:05:19 2019 CEDS_version_comparison.R [ 2 ] : Reading ../final-emissions/previous-versions/CEDS_CO2_global_emissions_by_fuel_v_frozen.csv 
    Done:  9  rows,  268  cols
Error in eval(ei, envir) : 
  previous_CEDS_sectors_mapped_with_ship_and_aviation should not have any NAs for RCP_sector after mapping. (503)
```




## Issue 2
As stated in the **Outcome** sub-section of the **Issue 1** section above, the following warning was raised for `CO2`:

```
Tue Dec 31 13:05:17 2019 CEDS_version_comparison.R [ 2 ] : Reading ../final-emissions/current-versions/CEDS_CO2_emissions_by_country_CEDS_sector_v_2016_07_26.csv 
    Done:  11491  rows,  269  cols
Tue Dec 31 13:05:18 2019 CEDS_version_comparison.R [ 2 ] : Reading ../final-emissions/current-versions/CEDS_CO2_global_emissions_by_fuel_v_2016_07_26.csv 
    Done:  9  rows,  268  cols
Tue Dec 31 13:05:18 2019 CEDS_version_comparison.R [ 2 ] : Reading ../final-emissions/previous-versions/CEDS_CO2_emissions_by_country_CEDS_sector_v_frozen.csv 
    Done:  11931  rows,  269  cols
Tue Dec 31 13:05:19 2019 CEDS_version_comparison.R [ 2 ] : Reading ../final-emissions/previous-versions/CEDS_CO2_global_emissions_by_fuel_v_frozen.csv 
    Done:  9  rows,  268  cols
Error in eval(ei, envir) : 
  previous_CEDS_sectors_mapped_with_ship_and_aviation should not have any NAs for RCP_sector after mapping. (503)
```

### Steps to solve
Similar to **Issue 1**, we will replace the frozen CO2 files in `previous-versions` with the CMIP6 release files from `current-versions`

* The appropriate files are already backed up from **Issue 1**
* CO2 files in `code/CEDS/final-emissions/previous-versions` were overwritten with those from `../current-versions` (1:13 p)
* CO2 files copied to `current-versions` were renamed
  ```
  $ python rename_files.py -d ".../CEDS/final-emissions/previous-versions" -t "2016_07_26" -n "frozen"
  
  Changing working directory to .../CEDS/final-emissions/previous-versions...
  
  Renaming files...
  CEDS_CO2_emissions_by_country_CEDS_sector_v_2016_07_26.csv --> CEDS_CO2_emissions_by_country_CEDS_sector_v_frozen.csv
  CEDS_CO2_emissions_by_country_sector_v_2016_07_26.csv -------> CEDS_CO2_emissions_by_country_sector_v_frozen.csv
  CEDS_CO2_emissions_by_country_v_2016_07_26.csv --------------> CEDS_CO2_emissions_by_country_v_frozen.csv
  CEDS_CO2_global_emissions_by_CEDS_sector_v_2016_07_26.csv ---> CEDS_CO2_global_emissions_by_CEDS_sector_v_frozen.csv
  CEDS_CO2_global_emissions_by_fuel_v_2016_07_26.csv ----------> CEDS_CO2_global_emissions_by_fuel_v_frozen.csv
  
  Finished!
  ```
* `CEDS_version_comparison.R` was re-run (1:17 p)

### Outcome

`borat-great_success.png`

However, there are some warnings:

```
Warning messages:
1: In eval(ei, envir) :
  The above isos are in the RCP region mapping file but not final CEDS isos in Master_Country_List.csv... 
2: In eval(ei, envir) :
  previous_CEDS_version is defined as a value that is not an available CEDS release version (see common_data.R for available versions).Comparing current CEDS version to the previous CEDS system run...
```




## Issue 3

The CEDS comparison script did not produce a new `CEDS_version_comparison-Aggregate_regions.pdf` plot.

### Steps to solve

* Fetch upstream changes
  * Make sure we have the proper `upstream` remote config:
  
    ```
    $ git remote -v
    origin  https://github.com/mnichol3/CEDS-dev.git (fetch)
    origin  https://github.com/mnichol3/CEDS-dev.git (push)
    upstream        https://github.com/JGCRI/CEDS-dev.git (fetch)
    upstream        https://github.com/JGCRI/CEDS-dev.git (push)
    ```
    
  * Checkout branch `master` and fetch changes from `upstream` remote
    ```
    $ git checkout master
    Switched to branch 'master'
    Your branch is up to date with 'origin/master'.
    
    $ git pull origin master
    Enter passphrase for key ...:
    From github.com:mnichol3/CEDS_Data
    * branch            master     -> FETCH_HEAD
    Already up to date.
    
    $ git fetch upstream
    remote: Enumerating objects: 25, done.
    remote: Counting objects: 100% (25/25), done.
    remote: Compressing objects: 100% (11/11), done.
    remote: Total 19 (delta 10), reused 17 (delta 8), pack-reused 0
    Unpacking objects: 100% (19/19), done.
    From https://github.com/JGCRI/...
       xxx...xxx  branch_1 -> upstream/branch_1
       xxx...xxx  master   -> upstream/master
    ```
    
  * Merge the changes from `upstream/master` and push to `origin/master` remote
    ```
    $ git merge upstream/master
    Merge made by the 'recursive' strategy.
    ...
    ...
    ...
    
    $ git push origin master
    Enter passphrase for key ...:
    Enumerating objects: 4, done.
    Counting objects: 100% (4/4), done.
    ...
    ...
    ...
    ```
    
  * Merge `origin/master` into `origin/frozen_ems`, push to `origin/frozen_ems` remote
    ```
    $ git checkout frozen_ems
    Switched to branch 'frozen_ems'
    
    $ git merge origin/master
    Auto-merging code/version-comparison/CEDS_version_comparison.R
    Merge made by the 'recursive' strategy.
    ...
    ...
    ...
    
    $ git push origin frozen_ems
    Enter passphrase for key ...:
    Enumerating objects: 11, done.
    Counting objects: 100% (11/11), done.
    ...
    ...
    ...
    ```
  * Configure `CEDS_version_comparison.R` on branch `frozen_ems`
    * `Line 71`: `previous_CEDS_version <- "v_frozen"`
    * `Line 74`: `current_CEDS_version <- "v_2016_07_26"`
